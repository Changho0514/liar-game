<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Details</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<main>
    <h2>플레이어</h2>
    <div id="nickname-section">
        <form id="nickname-form" onsubmit="setNickname(event)">
            <input type="text" id="nickname" placeholder="닉네임을 입력해주세요." required>
            <button type="submit">입장</button>
        </form>
    </div>
    <div id="player-list" style="display: none;"></div> <!-- 플레이어 목록을 표시할 div 추가 -->
    <div id="player-name-section" style="display: none;">
        <span id="player-name"></span> <!-- 닉네임을 표시할 span -->
    </div>
    <p>아래 링크를 공유하세요!</p>

    <p id="room-link" th:text="'ch-liar.store/room/' + ${roomCode}"></p>

    <p style="color: red; cursor: pointer;" onclick="copyLink()">링크 복사</p>

    <div>
        <button onclick="resetSessionAndGoHome()">홈으로</button>
        <button id="start-game-btn" style="display: none;">게임 시작</button>
    </div>

    <!-- 채팅 -->
    <h2>채팅</h2>
    <div id="messages"></div>
    <form id="chat-form" style="display: none;">
        <input type="text" id="content" placeholder="메시지" required>
        <button type="submit">전송</button>
    </form>
</main>

<!-- Modal -->
<div id="modal" class="modal">
    <div class="modal-content">
        <p>모든 플레이어가 입장했는지 확인해주세요.<br>1명의 플레이어로 게임을 시작하시겠습니까?</p>
        <div class="modal-buttons">
            <button class="modal-button" onclick="closeModal()">취소</button>
            <button class="modal-button" onclick="startGame()">확인</button>
        </div>
    </div>
</div>

<!-- 알림 메시지 -->
<div id="alert" class="alert" style="display:none; position:fixed; bottom:10px; right:10px; background-color:#f9edbe; padding:10px; border:1px solid #f0c36d; border-radius:5px;">링크가 복사되었습니다!</div>

<script>
    var stompClient = null;
    var nickname = '';

    function setNickname(event) {
        event.preventDefault();
        nickname = document.getElementById('nickname').value;
        sessionStorage.setItem('nickname', nickname); // 닉네임을 세션에 저장

        document.getElementById('nickname-section').style.display = 'none';
        document.getElementById('player-list').style.display = 'block';
        document.getElementById('player-name-section').style.display = 'block';
        document.getElementById('player-name').innerText = nickname;
        document.getElementById('start-game-btn').style.display = 'block';
        document.getElementById('chat-form').style.display = 'block';

        connect();
    }

    function connect() {
        var socket = new SockJS('/gs-guide-websocket'); // 올바른 SockJS 엔드포인트 설정
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            const roomCode = window.location.pathname.split('/').pop(); // 방 코드를 URL에서 가져옴

            // 방에 연결된 사용자 목록 수신
            stompClient.subscribe('/topic/room/' + roomCode + '/players', function (message) {
                updatePlayerList(JSON.parse(message.body));
            });

            // 채팅 메시지 수신
            stompClient.subscribe('/topic/room/' + roomCode + '/chat', function (message) {
                showMessage(JSON.parse(message.body));
            });

            // 방에 입장 메시지 전송
            stompClient.send("/app/room/" + roomCode + "/join", {}, JSON.stringify({ 'nickname': nickname }));
        });
    }

    function sendMessage() {
        const content = document.getElementById('content').value;
        const roomCode = window.location.pathname.split('/').pop();
        stompClient.send("/app/room/" + roomCode + "/chat", {}, JSON.stringify({'name': nickname, 'content': content}));
        document.getElementById('content').value = ''; // 메시지 전송 후 입력 칸 비우기
    }

    function showMessage(message) {
        const messages = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.appendChild(document.createTextNode(message.name + ": " + message.content));
        messages.appendChild(messageElement);
    }

    function updatePlayerList(players) {
        var playerList = document.getElementById('player-list'); // 플레이어 목록을 표시할 div
        if (!playerList) {
            console.error('player-list element not found');
            return;
        }
        playerList.innerHTML = '';
        players.forEach(function(player) {
            var playerElement = document.createElement('div');
            playerElement.appendChild(document.createTextNode(player));
            playerList.appendChild(playerElement);
        });
    }

    document.getElementById('chat-form').addEventListener('submit', function (event) {
        event.preventDefault();
        sendMessage();
    });

    window.onbeforeunload = function() {
        // 세션에서 닉네임 제거
        sessionStorage.removeItem('nickname');
        const roomCode = window.location.pathname.split('/').pop();
        // 서버에 나가기 메시지 전송
        if (stompClient) {
            stompClient.send("/app/room/" + roomCode + "/leave", {}, JSON.stringify({ 'nickname': nickname }));
        }
    };

    window.onload = function() {
        const savedNickname = sessionStorage.getItem('nickname');
        if (savedNickname) {
            nickname = savedNickname;
            document.getElementById('nickname-section').style.display = 'none';
            document.getElementById('player-list').style.display = 'block';
            document.getElementById('player-name-section').style.display = 'block';
            document.getElementById('player-name').innerText = nickname;
            document.getElementById('start-game-btn').style.display = 'block';
            document.getElementById('chat-form').style.display = 'block';

            connect();
        } else {
            document.getElementById('nickname-section').style.display = 'block';
        }

        document.getElementById('modal').style.display = 'none';
    }

    document.getElementById('start-game-btn').addEventListener('click', function() {
        document.getElementById('modal').style.display = 'block';
    });

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    function startGame() {
        // 게임 시작 요청을 서버로 전송
        fetch('/api/game/start/' + roomCode, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ nickname: nickname }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/game/' + roomCode;
                } else {
                    alert('Failed to start the game. Please try again.');
                }
            })
            .catch(handleError);
    }

    function resetSessionAndGoHome() {
        fetch('/room/reset-session', { method: 'POST' }) // 서버에 세션 초기화 요청
            .then(() => {
                location.href = '/'; // 홈으로 이동
            });
    }

    function copyLink() { // 링크 복사 함수 추가
        const roomLinkElement = document.getElementById('room-link');
        if (roomLinkElement) {
            const link = roomLinkElement.innerText;
            navigator.clipboard.writeText(link).then(() => {
                showAlert('링크가 복사되었습니다 ');
            }).catch(err => {
                console.error('복사 실패:', err);
            });
        }
    }

    function showAlert(message) { // 알림 메시지 함수 추가
        const alertElement = document.getElementById('alert');
        alertElement.innerText = message;
        alertElement.style.display = 'block';
        setTimeout(() => {
            alertElement.style.display = 'none';
        }, 2000);
    }

</script>
</body>
</html>